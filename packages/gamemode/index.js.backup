const { db } = require('../database');
const config = require('../config');
const security = require('../security');

// –°—á–µ—Ç—á–∏–∫ –∏–∑–º–µ—Ä–µ–Ω–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
let nextCreationDimension = config.DIMENSION.CREATION_START;

// –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞
mp.events.add('playerJoin', async (player) => {
    console.log(`[Server] –ò–≥—Ä–æ–∫ ${player.socialClub} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É`);
    
    player.dimension = 0;
    player.accountId = null;
    player.characterId = null;
    player.creationDimension = null;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–¥–º–∏–Ω —É—Ä–æ–≤–µ–Ω—å
    try {
        const [adminResult] = await db.query(
            'SELECT admin_level FROM users WHERE login = ?',
            [player.socialClub]
        );
        
        if (adminResult.length > 0) {
            player.adminLevel = adminResult[0].admin_level || 0;
            
            if (player.adminLevel > 0) {
                player.outputChatBox(`!{#4caf50}[–°–∏—Å—Ç–µ–º–∞] –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è ${player.adminLevel}`);
                player.outputChatBox(`!{#2196f3}[–ü–æ–¥—Å–∫–∞–∑–∫–∞] –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /admin –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏`);
                
                console.log(`[Server] ${player.socialClub} –≤–æ—à–µ–ª —Å –∞–¥–º–∏–Ω —É—Ä–æ–≤–Ω–µ–º ${player.adminLevel}`);
            }
        }
    } catch (err) {
        console.error('[Server] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω —É—Ä–æ–≤–Ω—è:', err);
    }
});

// === –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===

mp.events.add('server:login', async (player, login, password) => {
    try {
        console.log('='.repeat(60));
        console.log(`[Server] üîç –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: "${login}"`);
        
        // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –ª–æ–≥–∏–Ω—É –ò –ø–∞—Ä–æ–ª—é
        const [rows] = await db.query(
            'SELECT * FROM users WHERE login = ? AND password = ?',
            [login, password]
        );
        
        console.log(`[Server] –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${rows.length}`);
        
        if (rows.length === 0) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ª–æ–≥–∏–Ω –≤–æ–æ–±—â–µ
            const [checkLogin] = await db.query(
                'SELECT id FROM users WHERE login = ?',
                [login]
            );
            
            if (checkLogin.length > 0) {
                console.log(`[Server] ‚ùå –õ–æ–≥–∏–Ω –Ω–∞–π–¥–µ–Ω, –Ω–æ –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π`);
                player.call('client:authResponse', ['error', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å']);
            } else {
                console.log(`[Server] ‚ùå –õ–æ–≥–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                player.call('client:authResponse', ['error', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω']);
            }
            console.log('='.repeat(60));
            return;
        }
        
        const user = rows[0];
        
        console.log(`[Server] ÔøΩÔøΩÔøΩ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: ID=${user.id}, Login=${user.login}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥ –∏ IP
        await db.query(
            'UPDATE users SET last_login = NOW(), ip_address = ? WHERE id = ?',
            [player.ip, user.id]
        );
        
        player.accountId = user.id;
        player.socialClub = login;
        player.adminLevel = user.admin_level || 0;
        
        console.log(`[Server] ‚úÖ –ò–≥—Ä–æ–∫ ${login} —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (ID: ${user.id})`);
        
        if (player.adminLevel > 0) {
            console.log(`[Server] –ê–¥–º–∏–Ω —É—Ä–æ–≤–µ–Ω—å: ${player.adminLevel}`);
        }
        
        console.log('='.repeat(60));
        
        player.call('client:authResponse', ['success', '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!']);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        setTimeout(async () => {
            console.log(`[Server] üìã –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è user_id=${user.id}...`);
            
            const [characters] = await db.query(
                'SELECT id, name, surname, age, gender, money, bank, level, last_active FROM characters WHERE user_id = ?',
                [user.id]
            );
            
            console.log(`[Server] –ù–∞–π–¥–µ–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${characters.length}`);
            
            if (characters.length > 0) {
                console.log(`[Server] –°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:`);
                characters.forEach((char, index) => {
                    console.log(`  ${index + 1}. ID=${char.id}, Name=${char.name} ${char.surname}, Level=${char.level || 1}, Money=$${char.money}`);
                });
            }
            
            const charactersJson = JSON.stringify(characters);
            console.log(`[Server] –û—Ç–ø—Ä–∞–≤–∫–∞ JSON –∫–ª–∏–µ–Ω—Ç—É (–¥–ª–∏–Ω–∞: ${charactersJson.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
            
            player.call('client:showCharacterSelection', [charactersJson]);
            
            console.log(`[Server] ‚úÖ –ö–æ–º–∞–Ω–¥–∞ client:showCharacterSelection –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞`);
        }, 1000);
        
    } catch (err) {
        console.error('[Server] ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤—Ö–æ–¥–µ:', err);
        console.log('='.repeat(60));
        player.call('client:authResponse', ['error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞']);
    }
});

mp.events.add('server:register', async (player, login, password) => {
    try {
        console.log(`[Server] –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${login}`);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const [existing] = await db.query(
            'SELECT id FROM users WHERE login = ?',
            [login]
        );
        
        if (existing.length > 0) {
            console.log(`[Server] –õ–æ–≥–∏–Ω ${login} —É–∂–µ –∑–∞–Ω—è—Ç`);
            player.call('client:authResponse', ['error', '–õ–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç']);
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const [result] = await db.query(
            'INSERT INTO users (login, password, ip_address, registered_at, last_login, money, bank, level, exp, admin_level) VALUES (?, ?, ?, NOW(), NOW(), 5000, 10000, 1, 0, 0)',
            [login, password, player.ip]
        );
        
        player.accountId = result.insertId;
        player.socialClub = login;
        player.adminLevel = 0;
        
        console.log(`[Server] ‚úÖ –ò–≥—Ä–æ–∫ ${login} —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω (ID: ${result.insertId})`);
        
        player.call('client:authResponse', ['success', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!']);
        
        setTimeout(() => {
            // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            player.call('client:showCharacterSelection', [JSON.stringify([])]);
        }, 1000);
        
    } catch (err) {
        console.error('[Server] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', err);
        player.call('client:authResponse', ['error', '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏']);
    }
});

// === –°–ò–°–¢–ï–ú–ê –ü–ï–†–°–û–ù–ê–ñ–ï–ô ===

mp.events.add('server:enterCharacterCreation', (player) => {
    try {
        console.log(`[Server] –ò–≥—Ä–æ–∫ ${player.socialClub} –≤—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞`);
        
        player.creationDimension = nextCreationDimension++;
        player.dimension = player.creationDimension;
        
        console.log(`[Server] –ò–≥—Ä–æ–∫ ${player.socialClub} –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤ –∏–∑–º–µ—Ä–µ–Ω–∏–∏ ${player.creationDimension}`);
        
        player.call('client:showCharacterCreation');
        
    } catch (err) {
        console.error('[Server] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', err);
    }
});

mp.events.add('server:createCharacter', async (player, characterDataJson) => {
    try {
        console.log('='.repeat(60));
        console.log(`[Server] üé≠ –°–û–ó–î–ê–ù–ò–ï –ü–ï–†–°–û–ù–ê–ñ–ê`);
        console.log(`[Server] –ò–≥—Ä–æ–∫: ${player.socialClub} (AccountID: ${player.accountId})`);
        console.log(`[Server] Dimension: ${player.dimension}`);
        console.log(`[Server] –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${characterDataJson}`);
        
        const characterData = JSON.parse(characterDataJson);
        
        console.log(`[Server] –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:`);
        console.log(`  - –ò–º—è: ${characterData.name}`);
        console.log(`  - –§–∞–º–∏–ª–∏—è: ${characterData.surname}`);
        console.log(`  - –í–æ–∑—Ä–∞—Å—Ç: ${characterData.age}`);
        console.log(`  - –ü–æ–ª: ${characterData.gender}`);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        const [existingChars] = await db.query(
            'SELECT COUNT(*) as count FROM characters WHERE user_id = ?',
            [player.accountId]
        );
        
        console.log(`[Server] –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${existingChars[0].count}`);
        
        if (existingChars[0].count >= 3) {
            console.log(`[Server] ‚ùå –õ–∏–º–∏—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø—Ä–µ–≤—ã—à–µ–Ω`);
            player.call('client:characterCreationResponse', ['error', '–£ –≤–∞—Å —É–∂–µ 3 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!']);
            console.log('='.repeat(60));
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏
        const [nameCheck] = await db.query(
            'SELECT id FROM characters WHERE name = ? AND surname = ?',
            [characterData.name, characterData.surname]
        );
        
        console.log(`[Server] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏: –Ω–∞–π–¥–µ–Ω–æ ${nameCheck.length} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π`);
        
        if (nameCheck.length > 0) {
            console.log(`[Server] ‚ùå –ò–º—è –∑–∞–Ω—è—Ç–æ`);
            player.call('client:characterCreationResponse', ['error', '–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!']);
            console.log('='.repeat(60));
            return;
        }
        
        const startPosition = {
            x: -1037.7,
            y: -2738.5,
            z: 20.0,
            heading: 0
        };
        
        console.log(`[Server] –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è: X=${startPosition.x}, Y=${startPosition.y}, Z=${startPosition.z}`);
        console.log(`[Server] –í–Ω–µ—à–Ω–æ—Å—Ç—å: ${JSON.stringify(characterData.appearance)}`);
        
        // –°–û–ó–î–ê–ï–ú –ü–ï–†–°–û–ù–ê–ñ–ê
        console.log(`[Server] üíæ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ INSERT –∑–∞–ø—Ä–æ—Å–∞...`);
        
        const [result] = await db.query(
            `INSERT INTO characters 
            (user_id, name, surname, age, gender, money, bank, level, exp, health, armor, position_x, position_y, position_z, heading, dimension, appearance, created_at, last_active) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`,
            [
                player.accountId,
                characterData.name,
                characterData.surname,
                characterData.age,
                characterData.gender,
                1000,
                5000,
                1,
                0,
                100,
                0,
                startPosition.x,
                startPosition.y,
                startPosition.z,
                startPosition.heading,
                0,
                JSON.stringify(characterData.appearance)
            ]
        );
        
        console.log(`[Server] ‚úÖ INSERT —É—Å–ø–µ—à–µ–Ω! ID –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ${result.insertId}`);
        console.log(`[Server] Affected rows: ${result.affectedRows}`);
        
        // –ü–†–û–í–ï–†–Ø–ï–ú –ß–¢–û –ü–ï–†–°–û–ù–ê–ñ –†–ï–ê–õ–¨–ù–û –°–û–ó–î–ê–ù
        const [checkCreated] = await db.query(
            'SELECT * FROM characters WHERE id = ?',
            [result.insertId]
        );
        
        if (checkCreated.length > 0) {
            console.log(`[Server] ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï: –ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è`);
            console.log(`[Server] –î–∞–Ω–Ω—ã–µ: ID=${checkCreated[0].id}, Name=${checkCreated[0].name}, Surname=${checkCreated[0].surname}`);
        } else {
            console.log(`[Server] ‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä—Å–æ–Ω–∞–∂ –ù–ï –ù–ê–ô–î–ï–ù –≤ –ë–î –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è!`);
        }
        
        player.call('client:characterCreationResponse', ['success', '–ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!']);
        
        // –í–û–ó–í–†–ê–©–ê–ï–ú –í –û–°–ù–û–í–ù–û–ï –ò–ó–ú–ï–†–ï–ù–ò–ï
        player.dimension = 0;
        console.log(`[Server] –ò–≥—Ä–æ–∫ –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ dimension 0`);
        
        // –ó–ê–ì–†–£–ñ–ê–ï–ú –°–ü–ò–°–û–ö –ü–ï–†–°–û–ù–ê–ñ–ï–ô
        setTimeout(async () => {
            console.log(`[Server] üìã –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è user_id=${player.accountId}...`);
            
            const [characters] = await db.query(
                'SELECT id, name, surname, age, gender, money, bank, level, last_active FROM characters WHERE user_id = ?',
                [player.accountId]
            );
            
            console.log(`[Server] –ù–∞–π–¥–µ–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${characters.length}`);
            
            if (characters.length > 0) {
                console.log(`[Server] –°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:`);
                characters.forEach((char, index) => {
                    console.log(`  ${index + 1}. ID=${char.id}, Name=${char.name} ${char.surname}, Gender=${char.gender}, Money=$${char.money}, Level=${char.level || 1}`);
                });
            } else {
                console.log(`[Server] ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ü–£–°–¢!`);
            }
            
            const charactersJson = JSON.stringify(characters);
            console.log(`[Server] JSON –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${charactersJson}`);
            console.log(`[Server] –î–ª–∏–Ω–∞ JSON: ${charactersJson.length} —Å–∏–º–≤–æ–ª–æ–≤`);
            
            player.call('client:showCharacterSelection', [charactersJson]);
            
            console.log(`[Server] ‚úÖ –ö–æ–º–∞–Ω–¥–∞ client:showCharacterSelection –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞`);
            console.log('='.repeat(60));
            
        }, 1500);
        
    } catch (err) {
        console.error('[Server] ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', err);
        console.error('[Server] Stack trace:', err.stack);
        console.log('='.repeat(60));
        player.call('client:characterCreationResponse', ['error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!']);
    }
	
	console.log(`[Server] ‚úÖ INSERT —É—Å–ø–µ—à–µ–Ω! ID –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ${result.insertId}`);

// –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û:
// –í—ã–¥–∞—ë–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä
if (typeof global.addItem === 'function') {
    await global.addItem(result.insertId, 'water', 2);
    await global.addItem(result.insertId, 'bread', 3);
    await global.addItem(result.insertId, 'phone', 1);
    console.log('[Server] –°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –≤—ã–¥–∞–Ω –Ω–æ–≤–æ–º—É –ø–µ—Ä—Å–æ–Ω–∞–∂—É');
}
});

mp.events.add('server:selectCharacter', async (player, characterId) => {
    try {
        console.log('='.repeat(60));
        console.log(`[Server] üë§ –í–´–ë–û–† –ü–ï–†–°–û–ù–ê–ñ–ê`);
        console.log(`[Server] –ò–≥—Ä–æ–∫: ${player.socialClub} –≤—ã–±—Ä–∞–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ID: ${characterId}`);
        
        const [result] = await db.query(
            'SELECT * FROM characters WHERE id = ? AND user_id = ?',
            [characterId, player.accountId]
        );
        
        if (result.length === 0) {
            console.log('[Server] ‚ùå –ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∏–≥—Ä–æ–∫—É');
            console.log('='.repeat(60));
            return;
        }
        
        const character = result[0];
        
        player.characterId = character.id;
        player.name = `${character.name}_${character.surname}`;
        player.money = character.money;
        player.bank = character.bank;
        
        player.dimension = 0;
        console.log(`[Server] –ò–≥—Ä–æ–∫ ${player.socialClub} –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ (0)`);
        
        const characterData = {
            id: character.id,
            name: character.name,
            surname: character.surname,
            age: character.age,
            gender: character.gender,
            money: character.money,
            bank: character.bank,
            position_x: character.position_x,
            position_y: character.position_y,
            position_z: character.position_z,
            heading: character.heading,
            appearance: character.appearance ? JSON.parse(character.appearance) : null
        };
        
        console.log(`[Server] –î–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏`);
        console.log(`[Server] –ü–æ–∑–∏—Ü–∏—è —Å–ø–∞–≤–Ω–∞: X=${characterData.position_x}, Y=${characterData.position_y}, Z=${characterData.position_z}`);
        
        player.call('client:spawnCharacter', [JSON.stringify(characterData)]);
        
        console.log(`[Server] ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ ${character.name} ${character.surname} –∑–∞–≥—Ä—É–∂–µ–Ω`);
        console.log('='.repeat(60));
        
    } catch (err) {
        console.error('[Server] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', err);
        console.log('='.repeat(60));
    }
});

mp.events.add('server:deleteCharacter', async (player, characterId) => {
    try {
        console.log('='.repeat(60));
        console.log(`[Server] üóëÔ∏è –£–î–ê–õ–ï–ù–ò–ï –ü–ï–†–°–û–ù–ê–ñ–ê`);
        console.log(`[Server] –ò–≥—Ä–æ–∫: ${player.socialClub}, CharacterID: ${characterId}`);
        
        const [result] = await db.query(
            'DELETE FROM characters WHERE id = ? AND user_id = ?',
            [characterId, player.accountId]
        );
        
        if (result.affectedRows > 0) {
            console.log(`[Server] ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ ID: ${characterId} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`);
            player.call('client:characterDeletionResponse', ['success', '–ü–µ—Ä—Å–æ–Ω–∞–∂ —É–¥–∞–ª–µ–Ω!']);
            
            // –û–ë–ù–û–í–õ–Ø–ï–ú –°–ü–ò–°–û–ö
            setTimeout(async () => {
                const [characters] = await db.query(
                    'SELECT id, name, surname, age, gender, money, bank, level, last_active FROM characters WHERE user_id = ?',
                    [player.accountId]
                );
                
                console.log(`[Server] –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${characters.length} —à—Ç.`);
                
                player.call('client:updateCharacterList', [JSON.stringify(characters)]);
            }, 500);
        } else {
            console.log(`[Server] ‚ùå –ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∏–≥—Ä–æ–∫—É`);
            player.call('client:characterDeletionResponse', ['error', '–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω!']);
        }
        
        console.log('='.repeat(60));
        
    } catch (err) {
        console.error('[Server] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', err);
        console.log('='.repeat(60));
        player.call('client:characterDeletionResponse', ['error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏!']);
    }
});

mp.events.add('playerQuit', async (player, exitType, reason) => {
    try {
        console.log(`[Server] –ò–≥—Ä–æ–∫ ${player.socialClub} –æ—Ç–∫–ª—é—á–∏–ª—Å—è (–¢–∏–ø: ${exitType})`);
        
        if (player.creationDimension) {
            console.log(`[Server] –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ –∏–∑–º–µ—Ä–µ–Ω–∏–µ ${player.creationDimension}`);
            delete player.creationDimension;
        }
        
        if (player.characterId) {
            const pos = player.position;
            
            await db.query(
                'UPDATE characters SET position_x = ?, position_y = ?, position_z = ?, heading = ?, last_active = NOW() WHERE id = ?',
                [pos.x, pos.y, pos.z, player.heading, player.characterId]
            );
            
            console.log(`[Server] –ü–æ–∑–∏—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ID: ${player.characterId} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`);
        }
        
    } catch (err) {
        console.error('[Server] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞:', err);
    }
});

console.log('[Server] ‚úÖ –ò–≥—Ä–æ–≤–æ–π —Ä–µ–∂–∏–º –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ!');